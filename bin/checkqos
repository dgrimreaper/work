#!/usr/bin/perl
# Short tool to give an indication of amount of shares used this quarter

use Getopt::Long;
use Pod::Usage;
use Date::Format;
use strict;
use warnings;
my %users;
my $inqos = 0;
my $nusers = 0;
my $naccounts = 0;
my %partitionusers;
my %partitionaccounts;
my $partition;

open(ASSOC,"scontrol show assoc |");
while(<ASSOC>){
    next if /^Current/;
    next if /^User Records/;
    next if /Account Limits/;
    next if /User Limits/;
    chomp;
    my $line = $_;
    if ($line =~ /ClusterName=(.+?) Account=(.+?) UserName=(.+?)\((\d+)\) Partition=(.+?) ID=(.+?)/) {
      my $account=$2;
      my $user=$3;
      my $partition=$5;
      $partitionusers{$partition}{$user}=1;
      $partitionaccounts{$partition}{$account}=1;
    }
    if ($line =~ /UserName=(.+)\((\d+)\)/) {
      my $user = $1;
      my $usernum = $2;
      $users{$usernum}=$user;
    }
    if ($line =~ /QOS=(.+)\((\d+)\)/) {
      my $qos = $1;
#      my $qosnum = $2;
      if (! $inqos) {
        print "\nSLURM Association Summary:\n";
        foreach $partition (keys %partitionusers) {
          my $n = keys %{ $partitionusers{$partition} };
          print "Users in $partition is $n\n";
        }
        foreach $partition (keys %partitionaccounts) {
          my $n = keys %{ $partitionaccounts{$partition} };
          print "Accounts in $partition is $n\n";
        }
        print "\nExplicit QOS Entries:\n";
      }
      if ($inqos) {
        print "  number of accounts = $naccounts\n";
        print "  number of users = $nusers\n";
        $naccounts=0;
        $nusers=0;
      }
      $inqos=1;
      print "QOS $qos\n";
    }
    if ($inqos==1) {
      if ($line =~ /Account (.+)/) {
        print "  Account $1\n";
        $naccounts++;
      }
      if ($line =~ /User (.+)/) {
        my $user = $users{$1};
        print "  User $user\n";
        $nusers++;
      }
    }
}
      if ($inqos) {
        print "  number of accounts = $naccounts\n";
        print "  number of users = $nusers\n";
        $naccounts=0;
        $nusers=0;
      }

#reaper@magnus-2:~> sacctmgr show qos format="name%-20,priority"
#                Name   Priority
#-------------------- ----------
#normal                    10000
#disciplinary                  0
#longqos                       0
#benthos                    3000
#askaprt                   20000
#pawseyoverride                0
#prohibit                      0
#highqos                   20000

#Get priority weight
#reaper@magnus-2:~> grep PriorityWeightQOS /etc/opt/slurm/slurm.conf
#PriorityWeightQOS=10000

#sacctmgr show assoc format="name%-20,Account%-20,ID,Qos,User"

